{% extends "base.html" %}

{% block main %}
<div style="max-width:900px; margin:40px auto; padding:20px;">
    <div style="text-align:center; margin-bottom:40px; background:white; padding:30px; border-radius:20px; 
                box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h1 style="font-size:2.6rem; color:#2c3e50; margin-bottom:10px;">
            {{ subject.name }}
        </h1>
        <p style="font-size:1.4rem; color:#666;">
            Попытка №{{ attempt }} • {{ questions|length }} заданий
        </p>
        <div id="timer" style="font-size:2rem; color:#e74c3c; font-weight:bold; margin-top:20px;">
            Бақия: 30с
        </div>
        <div id="question-counter" style="margin-top:10px; font-size:1.2rem; color:#7f8c8d;">
            Савол 1 аз {{ questions|length }}
        </div>
        <div style="margin-top:20px; color:#e74c3c; font-weight:600; font-size:1.1rem;">
            Ҳар савол 30 сония вақт дорад • Тест фақат як маротиба супорида мешавад
        </div>
    </div>

    <form id="testForm" method="post" action="{% url 'finish_test' cluster.id subject.id %}">
        {% csrf_token %}
        <input type="hidden" name="attempt" value="{{ attempt }}">

        {% for item in questions %}
        <div class="question" 
             id="q_{{ forloop.counter0 }}" 
             data-qid="{{ item.question.id }}"
             style="display: {% if forloop.counter0 == current_index|default:0 %}block{% else %}none{% endif %};
                    background:white; border-radius:16px; padding:32px; margin-bottom:30px; 
                    box-shadow:0 10px 30px rgba(0,0,0,0.1); border-left:6px solid #3498db;">
            
            <div style="display:flex; align-items:flex-start; gap:18px;">
                <span style="background:#3498db; color:white; width:44px; height:44px; border-radius:50%; 
                            display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.3rem; flex-shrink:0;">
                    {{ forloop.counter }}
                </span>
                <div style="flex:1;">
                    <p style="font-size:1.4rem; color:#2c3e50; margin-bottom:24px; line-height:1.6; font-weight:500;">
                        {{ item.question.text }}
                    </p>

                    <div style="display:grid; gap:16px;">
                        {% for answer in item.answers %}
                        <label style="display:flex; align-items:center; background:#f8f9fa; padding:18px 22px; 
                                     border-radius:14px; cursor:pointer; transition:all 0.3s; border:2px solid transparent;
                                     hover:border:#3498db;">
                            <input type="radio" name="q_{{ item.question.id }}" value="{{ answer.id }}"
                                   style="margin-right:16px; transform:scale(1.4); accent-color:#3498db;">
                            <span style="font-size:1.2rem; color:#2c3e50;">{{ answer.text }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Пинҳонӣ submit барои охирин савол -->
        <button type="submit" id="submitBtn" style="display:none;"></button>
    </form>

    <div style="text-align:center; margin-top:50px;">
        <a href="{% url 'subjects_list' cluster.id %}" style="color:#95a5a6; text-decoration:none; font-size:0.95rem;">
            ← Баргаштан ба рӯйхати фанҳо
        </a>
    </div>
</div>

<script>
    const questions = document.querySelectorAll('.question');
    const totalQuestions = questions.length;
    let currentIndex = {{ current_index|default:0 }};
    const sessionId = {{ session_id }};
    const timePerQuestion = 30;
    let timerInterval;

    function updateCounter() {
        document.getElementById('question-counter').textContent = 
            `Савол ${currentIndex + 1} аз ${totalQuestions}`;
    }

    function showQuestion(index) {
        questions.forEach((q, i) => {
            q.style.display = i === index ? 'block' : 'none';
        });
        updateCounter();
    }

    function startTimer() {
        let timeLeft = timePerQuestion;
        const timerDisplay = document.getElementById('timer');
        timerDisplay.textContent = `Бақия: ${timeLeft}с`;

        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = `Бақия: ${timeLeft}с`;
            timerDisplay.style.color = timeLeft <= 10 ? '#e74c3c' : '#e74c3c';

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                nextQuestion();
            }
        }, 1000);
    }

    async function nextQuestion() {
        clearInterval(timerInterval);

        // Нигоҳ доштани ҷавоби интихобшуда
        const currentQuestionDiv = questions[currentIndex];
        const selected = currentQuestionDiv.querySelector(`input[name="q_${currentQuestionDiv.dataset.qid}"]:checked`);
        
        if (selected) {
            await fetch("{% url 'save_answer' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    question_id: currentQuestionDiv.dataset.qid,
                    answer_id: selected.value
                })
            });
        }

        // Нигоҳ доштани прогресс
        await fetch("{% url 'update_progress' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                session_id: sessionId,
                current_index: currentIndex + 1
            })
        });

        currentIndex++;

        if (currentIndex >= totalQuestions) {
            document.getElementById('testForm').submit();
            return;
        }

        showQuestion(currentIndex);
        startTimer();
    }

    // Оғози тест
    showQuestion(currentIndex);
    startTimer();

    // Илова кардани имкони гузариш бо тугмаи "Навбатӣ" (ихтиёрӣ)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === ' ') {
            e.preventDefault();
            clearInterval(timerInterval);
            nextQuestion();
        }
    });
</script>
{% endblock %}